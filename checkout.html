<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checkout - Normalitylb</title>
<link rel="stylesheet" href="styles.css">
<style>
.checkout-wrapper{
  max-width:980px;
  margin:3.5rem auto;
  padding:1.5rem;
  display:grid;
  grid-template-columns:1fr 380px;
  gap:2rem;
}
.checkout-card{
  background:#fff;
  border-radius:1rem;
  padding:1.25rem;
  box-shadow:0 8px 25px rgba(0,0,0,.08);
}
.form-group{margin-bottom:1rem;}
.form-group label{display:block;font-weight:600;margin-bottom:.35rem;}
.form-group input,
.form-group textarea,
.form-group select{
  width:100%;
  padding:.7rem;
  border:1px solid #d1d5db;
  border-radius:.5rem;
}
.summary-item{
  display:flex;
  justify-content:space-between;
  margin-bottom:.6rem;
}
.btn-place-order{
  width:100%;
  padding:1rem;
  background:#c3026c;
  color:#fff;
  border:none;
  border-radius:.6rem;
  font-weight:700;
  cursor:pointer;
  margin-top:1rem;
}
</style>
</head>
<body>

<header class="header">
<div class="header-container">
<div class="logo"><a href="index.html">Normalitylb</a></div>

<nav class="nav" id="navMenu">
    <a href="index.html" class="nav-link">Home</a>
    <a href="products.html" class="nav-link">Products</a>
    <a href="about.html" class="nav-link">About</a>
    <a href="contact.html" class="nav-link">Contact</a>
    <a href="orders.html" class="nav-link">Orders</a>
</nav>

<button class="menu-btn" id="menuBtn">â˜°</button>

<a href="cart.html" class="cart-icon">
  ðŸ›’ <span class="cart-count">0</span>
</a>
</div>
</header>

<main class="page-wrapper">
<section class="products-hero">
<h1>Checkout</h1>
<p>Fill your information to complete the order</p>
</section>

<div class="checkout-wrapper">
<!-- LEFT FORM -->
<div class="checkout-card">
<h2 style="color:#c3026c;margin-bottom:.75rem">Shipping & Contact</h2>
<form id="checkoutForm">
<div class="form-group">
<label>Full name</label>
<input id="fullName" required>
</div>
<div class="form-group">
<label>Phone</label>
<input id="phone" required>
</div>
<div class="form-group">
<label>Address</label>
<input id="address" required>
</div>
<div class="form-group">
<label>City</label>
<input id="city" required>
</div>
<div class="form-group">
<label>Notes</label>
<textarea id="notes"></textarea>
</div>
<div class="form-group">
<label>Promo code</label>
<input id="Promocode">
</div>
<div class="form-group">
<label>Payment method</label>
<select id="paymentMethod">
<option value="cash">Cash on delivery (Delivery +$4)</option>
<option value="pickup">Pick up from Dbaye (Free)</option>
</select>
</div>
<button type="submit" class="btn-place-order">Place Order</button>
</form>
</div>

<!-- RIGHT SUMMARY -->
<aside class="checkout-card checkout-summary">
<h3>Order Summary</h3>
<div id="summaryItems"></div>
<hr>
<div class="summary-item">
<strong>Subtotal</strong>
<span id="summarySubtotal">$0.00</span>
</div>
<div class="summary-item" id="discountRow" style="display:none">
<strong>Discount</strong>
<span id="summaryDiscount">-$0.00</span>
</div>
<div class="summary-item" id="shippingRow">
<strong>Shipping</strong>
<span id="summaryShipping">Calculated</span>
</div>
<div class="summary-item" style="font-size:1.2rem">
<strong>Total</strong>
<strong id="summaryTotal" style="color:#c3026c">$0.00</strong>
</div>
</aside>
</div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let cart = JSON.parse(localStorage.getItem("cart")) || [];
document.querySelector(".cart-count").textContent = cart.length;

const summaryItems = document.getElementById("summaryItems");
const subtotalEl = document.getElementById("summarySubtotal");
const totalEl = document.getElementById("summaryTotal");
const promoInput = document.getElementById("Promocode");
const discountRow = document.getElementById("discountRow");
const discountEl = document.getElementById("summaryDiscount");
const shippingEl = document.getElementById("summaryShipping");
const paymentMethod = document.getElementById("paymentMethod");

let subtotal = 0;
let discount = 0;
let shippingCost = 0;

const PROMO_CODE = "FIRST10";
const PROMO_KEY = "promo_FIRST10_used";
const WHATSAPP_NUMBER = "96176370139";

function extractPrice(val){
  return parseFloat(String(val).replace(/[^0-9.]/g,"")) || 0;
}

function renderSummary(){
  summaryItems.innerHTML="";
  subtotal=0;
  cart.forEach(item=>{
    const price = extractPrice(item.price);
    subtotal += price;
    summaryItems.innerHTML += `<div class="summary-item"><span>${item.name}</span><span>$${price.toFixed(2)}</span></div>`;
  });
  subtotalEl.textContent="$"+subtotal.toFixed(2);
  calculateTotal();
}

function calculateTotal(){
  const method = paymentMethod.value;
  shippingCost = method==="cash" ? 4 : 0;
  shippingEl.textContent = shippingCost>0 ? "$"+shippingCost.toFixed(2) : "Free";

  let total=subtotal;
  if(discount>0){ 
    let d=subtotal*discount;
    discountEl.textContent="-$"+d.toFixed(2);
    discountRow.style.display="flex";
    total-=d;
  }else{ discountRow.style.display="none"; }

  total += shippingCost;
  totalEl.textContent="$"+total.toFixed(2);
}

// Promo code logic
promoInput.addEventListener("input", ()=>{
  const code = promoInput.value.trim().toUpperCase();
  if(code===PROMO_CODE){
    if(localStorage.getItem(PROMO_KEY)==="true"){
      discount=0;
      alert("âŒ Promo already used");
    }else{
      discount=0.10;
      localStorage.setItem(PROMO_KEY,"true");
      alert("âœ… 10% OFF applied");
    }
  }else{ discount=0; }
  calculateTotal();
});

paymentMethod.addEventListener("change", calculateTotal);

// Generate PDF
function generateOrderPDF(order){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y=20;
  doc.setFontSize(18);
  doc.text("Normalitylb - Order Invoice",20,y); y+=10;
  doc.setFontSize(11);
  doc.text("Order ID: "+order.id,20,y); y+=7;
  doc.text("Date: "+order.date,20,y); y+=10;
  doc.text("Customer:",20,y); y+=7;
  doc.text("Name: "+order.customer.name,20,y); y+=6;
  doc.text("Phone: "+order.customer.phone,20,y); y+=6;
  doc.text("City: "+order.customer.city,20,y); y+=6;
  doc.text("Address: "+order.customer.address,20,y); y+=6;
  doc.text("Notes: "+(order.customer.notes||"None"),20,y); y+=10;
  doc.text("Products:",20,y); y+=6;
  order.items.forEach(i=>{
    const p=extractPrice(i.price);
    doc.text(`- ${i.name}: $${p.toFixed(2)}`,25,y);
    y+=6;
  });
  y+=6;
  doc.text("Subtotal: $"+order.subtotal.toFixed(2),20,y); y+=6;
  doc.text("Discount: "+order.discountPercent.toFixed(0)+"%",20,y); y+=6;
  doc.text("Shipping: $"+order.shipping.toFixed(2),20,y); y+=6;
  doc.text("Total: $"+order.total.toFixed(2),20,y);
  doc.save(order.id+".pdf");
}

// Submit form
document.getElementById("checkoutForm").addEventListener("submit", e=>{
  e.preventDefault();
  if(cart.length===0){ alert("Your cart is empty"); return; }

  const method = paymentMethod.value;
  shippingCost = method==="cash"?4:0;

  const order={
    id:"ORD-"+Date.now(),
    date:new Date().toLocaleString(),
    items:cart,
    subtotal:subtotal,
    discountPercent:discount*100,
    shipping: shippingCost,
    total: extractPrice(totalEl.textContent),
    promocode: promoInput.value.trim(),
    customer:{
      name:fullName.value,
      phone:phone.value,
      address:address.value,
      city:city.value,
      notes:notes.value,
      paymentMethod:paymentMethod.value
    }
  };

  const orders=JSON.parse(localStorage.getItem("orders"))||[];
  orders.push(order);
  localStorage.setItem("orders",JSON.stringify(orders));

  // PDF
  generateOrderPDF(order);

  // WhatsApp message
  const itemsText = order.items.map(i=>{
    const p = extractPrice(i.price);
    return `- ${i.name}: $${p.toFixed(2)}`;
  }).join("\n");

  const msg = `ðŸ›’ *New Order* ðŸ›’
Order ID: ${order.id}
Date: ${order.date}

*Customer Info*
Name: ${order.customer.name}
Phone: ${order.customer.phone}
City: ${order.customer.city}
Address: ${order.customer.address}
Notes: ${order.customer.notes || "None"}
Payment: ${order.customer.paymentMethod}

*Products*
${itemsText}

Subtotal: $${order.subtotal.toFixed(2)}
Discount: ${order.discountPercent.toFixed(0)}%
Shipping: $${order.shipping.toFixed(2)}
Total: $${order.total.toFixed(2)}
Promo code: ${order.promocode || "None"}`;

  const whatsappURL = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`;

  const win = window.open(whatsappURL,"_blank");
  if(!win) alert("Please allow popups to send WhatsApp message.");

  localStorage.removeItem("cart");
  window.location.href="thankyou.html?order="+order.id;
});

renderSummary();
</script>
</body>
</html>
